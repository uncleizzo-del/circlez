<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>CIRCLEZ v2.1</title>
    <style>
      :root{--bg:#071126;--panel:rgba(2,6,23,0.45);--muted:rgba(229,231,235,0.8);--accent:#22c55e}
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow-x:hidden}
      body{background:linear-gradient(180deg,#02030a 0%,#071126 60%);color:var(--muted);-webkit-font-smoothing:antialiased}
      #root{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:12px;overflow-x:hidden}
      .app{width:100%;max-width:760px;overflow-x:hidden}
      .brand{display:flex;align-items:center;gap:16px;margin-bottom:16px;padding:12px 0;background:linear-gradient(90deg,rgba(34,197,94,0.05),transparent);border-radius:12px;padding-left:12px}
      .brand-title{font-weight:900;letter-spacing:3px;font-size:24px;color:#22c55e;text-shadow:0 0 20px rgba(34,197,94,0.5);text-transform:uppercase}
      .brand-logo{width:56px;height:56px;border-radius:12px;object-fit:cover;display:block;box-shadow:0 4px 20px rgba(34,197,94,0.3);transition:all 0.3s ease}
      .brand-logo:hover{transform:scale(1.05);box-shadow:0 8px 30px rgba(34,197,94,0.5)}
      .orb{width:44px;height:44px;border-radius:999px;background:radial-gradient(circle at 20% 20%,var(--accent),#081028);display:grid;place-items:center;font-weight:800;color:#e6eef0;transition:box-shadow 0.3s ease}
      .orb.glow{box-shadow:0 0 20px rgba(34,197,94,0.6),0 0 40px rgba(34,197,94,0.4)}

      .panel{background:var(--panel);border:1px solid rgba(148,163,184,0.08);border-radius:14px;padding:12px;margin-bottom:12px}
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .input,.textarea{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid rgba(148,163,184,0.08);background:transparent;color:var(--muted);padding:8px;font-size:16px}
      .textarea{min-height:80px;resize:vertical}
      .btn{background:transparent;border:1px solid rgba(148,163,184,0.12);color:var(--muted);border-radius:999px;padding:8px 12px;cursor:pointer;transition:box-shadow 0.3s ease;white-space:nowrap;font-size:14px}
      .btn.primary{background:rgba(34,197,94,0.12);border-color:rgba(34,197,94,0.3);color:#e6fff0}
      .btn.primary.glow{box-shadow:0 0 20px rgba(34,197,94,0.5),0 0 30px rgba(34,197,94,0.3)}
      .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
      .chip{padding:8px 12px;border-radius:999px;border:1.5px solid rgba(34,197,94,0.5);background:rgba(0,0,0,0.3);color:rgba(34,197,94,0.9);cursor:pointer;box-shadow:0 0 10px rgba(34,197,94,0.3),inset 0 1px 1px rgba(34,197,94,0.1);transition:all 0.3s ease;font-weight:500;font-size:13px;flex-shrink:0}
      .chip.selected{background:rgba(34,197,94,0.15);border-color:rgba(34,197,94,0.8);color:#e6fff0;box-shadow:0 0 15px rgba(34,197,94,0.5),0 0 25px rgba(34,197,94,0.3),inset 0 1px 1px rgba(34,197,94,0.2)}
      .post{padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);margin-bottom:10px;word-wrap:break-word}
      .post .meta{font-size:12px;opacity:0.8}
      .tags{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}

      .stories{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch}
      .story{display:flex;flex-direction:column;align-items:center;gap:6px}
      .story-ring{width:58px;height:58px;border-radius:999px;padding:2px;background:radial-gradient(60% 60% at 50% 50%, rgba(34,197,94,0.5), rgba(34,197,94,0.15));box-shadow:0 0 18px rgba(34,197,94,0.3)}
      .story-ava{width:54px;height:54px;border-radius:999px;object-fit:cover;border:2px solid rgba(0,0,0,0.4);background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:#bfffd5;font-weight:700}
      .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:50}
      .overlay-card{width:min(92vw,520px);max-height:86vh;overflow:auto;background:rgba(2,6,23,0.85);border:1px solid rgba(148,163,184,0.15);border-radius:12px;padding:14px}

      .font-default{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      .font-serif{font-family:Georgia,Cambria,Times New Roman,serif}
      .font-mono{font-family:ui-monospace,SFMono-Regular,Monaco,Courier New,monospace}
      .font-rounded{font-family:ui-rounded,SF Pro Rounded,system-ui,-apple-system}
      .font-display{font-family:Impact,Haettenschweiler,Arial Black,sans-serif;letter-spacing:0.5px}

      @media (min-width:900px){#root{align-items:center}.app{max-width:980px}}
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script>
      const { useState, useEffect } = React;

      // KEEP YOUR KEYS (unchanged)
      const SUPABASE_URL = "https://ddlcukufdiytyfhpynzo.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_yxi2hoOXBYUhLgW2LvJUWw_O7o5T7i2";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const MAX_INTRO_VIDEO_BYTES = 25 * 1024 * 1024;
      const MAX_PROFILE_PHOTO_BYTES = 10 * 1024 * 1024;
      const MAX_POST_VIDEO_BYTES = 150 * 1024 * 1024;
      const MAX_POST_IMAGE_BYTES = 10 * 1024 * 1024;

      function safeAlert(msg){try{alert(msg)}catch(e){console.error(msg)}}
      async function uploadToBucket(file,userId,folder){
        if(!file){console.error('No file provided');return null;}
        console.log('ðŸš€ Starting upload:',{userId,folder,fileName:file.name,size:file.size});
        const ts=Date.now();
        const safeName=(file.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path=`${userId}/${folder}/${ts}_${safeName}`;
        console.log('ðŸ“ Upload path:',path);
        const { data, error } = await supabase.storage.from('media').upload(path,file,{cacheControl:'3600',upsert:false});
        if(error){
          console.error('âŒ Upload error:',error);
          safeAlert(`Upload failed: ${error.message||JSON.stringify(error)}`);
          return null;
        }
        console.log('âœ… Upload success, getting public URL...');
        const { data: pub } = supabase.storage.from('media').getPublicUrl(path);
        console.log('ðŸ”— Public URL:',pub?.publicUrl);
        return pub?.publicUrl||null;
      }
      function getHandleForUser(user){const email=(user?.email||"").toLowerCase();if(email==="uncleizzo@gmail.com")return"@uncleophilly";const base=email?email.split('@')[0]:'member';return'@'+base.toLowerCase()}
      function isAdmin(user){const email=(user?.email||"").toLowerCase();return email==="uncleizzo@gmail.com"}
      function formatDate(iso){if(!iso)return'';return new Date(iso).toLocaleString()}

      function CertifiedBadge({size=20}){
        return React.createElement('svg',{width:size,height:size,viewBox:'0 0 100 100',style:{display:'inline-block',verticalAlign:'middle',filter:'drop-shadow(0 2px 4px rgba(34,197,94,0.4))'}},
          React.createElement('defs',null,
            React.createElement('path',{id:'circlePath',d:'M 50 50 m -40 0 a 40 40 0 1 1 80 0 a 40 40 0 1 1 -80 0'}),
            React.createElement('linearGradient',{id:'stampGrad',x1:'0%',y1:'0%',x2:'100%',y2:'100%'},
              React.createElement('stop',{offset:'0%',style:{stopColor:'#22c55e',stopOpacity:1}}),
              React.createElement('stop',{offset:'100%',style:{stopColor:'#16a34a',stopOpacity:1}})
            )
          ),
          React.createElement('circle',{cx:50,cy:50,r:48,fill:'url(#stampGrad)',stroke:'#22c55e',strokeWidth:2,opacity:0.95}),
          React.createElement('circle',{cx:50,cy:50,r:42,fill:'none',stroke:'#22c55e',strokeWidth:1,strokeDasharray:'2,3',opacity:0.6}),
          React.createElement('text',{fontSize:9,fontWeight:'bold',fill:'white',letterSpacing:1.5},
            React.createElement('textPath',{href:'#circlePath',startOffset:'50%',textAnchor:'middle'},'CERTIFIED â€¢ OFFICIAL')
          ),
          React.createElement('circle',{cx:50,cy:50,r:28,fill:'#16a34a'}),
          React.createElement('text',{x:50,y:56,textAnchor:'middle',fontSize:36,fontWeight:'900',fill:'white',fontFamily:'Impact'},'C'),
          React.createElement('circle',{cx:50,cy:50,r:28,fill:'none',stroke:'#22c55e',strokeWidth:1.5,opacity:0.8})
        )
      }

      function LoginScreen({onSignIn}){
        return React.createElement('div',{className:'panel panel-login'},
          React.createElement('div',{className:'brand'},
            React.createElement('img',{src:logoUrl||'cz-logo.png',alt:'CIRCLEZ',className:'brand-logo',style:{width:44,height:44}}),
            React.createElement('div',null,
              React.createElement('div',{className:'brand-title'},'CIRCLEZ')
            )
          ),
          React.createElement('div',{style:{height:8}}),
          React.createElement('button',{className:'btn primary',onClick:async()=>{
            await supabase.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.origin}})
          }},'Sign in with Google')
        )
      }

      function App(){
        const [session,setSession]=useState(null);
        const [loading,setLoading]=useState(true);
        const [profile,setProfile]=useState(null);
        const [displayName,setDisplayName]=useState('');
        const [location,setLocation]=useState('');
        const [bio,setBio]=useState('');
        const [fontStyle,setFontStyle]=useState('default');
        const [uploadingPhoto,setUploadingPhoto]=useState(false);
        const [uploadingVideo,setUploadingVideo]=useState(false);
        const [pendingPhoto,setPendingPhoto]=useState(null);
        const [pendingPhotoUrl,setPendingPhotoUrl]=useState(null);
        const [editingProfile,setEditingProfile]=useState(false);

        const [content,setContent]=useState('');
        const [selectedCircles,setSelectedCircles]=useState(['Family']);
        const [selectedMoods,setSelectedMoods]=useState([]);
        const [feed,setFeed]=useState([]);
        const [loadingFeed,setLoadingFeed]=useState(false);
        const [storiesCircle,setStoriesCircle]=useState('Family');
        const [storiesMembers,setStoriesMembers]=useState([]);
        const [storyOpen,setStoryOpen]=useState(null);
        const [storyPosts,setStoryPosts]=useState([]);
        const [storyIndex,setStoryIndex]=useState(0);
        
        const [searchEmail,setSearchEmail]=useState('');
        const [searchResult,setSearchResult]=useState(null);
        const [myFollowers,setMyFollowers]=useState([]);
        const [logoUrl,setLogoUrl]=useState('cz-logo.png');
        const [uploadingLogo,setUploadingLogo]=useState(false);
        const [currentView,setCurrentView]=useState('feed');
        const [mediaGallery,setMediaGallery]=useState([]);
        const [composeMedia,setComposeMedia]=useState([]);
        const [composingMedia,setComposingMedia]=useState(false);

        useEffect(()=>{
          supabase.auth.getSession().then(({data})=>{
            setSession(data.session||null);setLoading(false);
            if(data.session){loadProfile(data.session.user);loadFeed();loadLogo()}
          }).catch(err=>{console.error('Session error:',err);setLoading(false)});
          const { data: listener } = supabase.auth.onAuthStateChange((_e,sess)=>{setSession(sess);if(sess){loadProfile(sess.user);loadFeed();loadLogo()}else{setProfile(null);setFeed([])}})
          return ()=>listener.subscription.unsubscribe();
        },[])

        useEffect(()=>{if(session){loadStories(storiesCircle)}},[session,storiesCircle])

        async function loadProfile(user){
          if(!user)return;
          const { data:row, error } = await supabase.from('profiles').select('*').eq('id',user.id).maybeSingle();
          let p = row;
          if(!p){
            const initial={id:user.id,handle:getHandleForUser(user),display_name:user.user_metadata?.full_name||'',bio:'',location:'',font_style:'default',username_colc:'#e5e7eb',avatar_url:null,profile_photo_:null,certified:false}
            const ins = await supabase.from('profiles').insert(initial).select('*').maybeSingle();
            if(ins.error)console.error('Profile insert:',ins.error);p=ins.data||null
          }
          if(p){setProfile(p);setDisplayName(p.display_name||'');setLocation(p.location||'');setBio(p.bio||'');setFontStyle(p.font_style||'default')}
        }

        async function saveProfile(){if(!session)return;const payload={display_name:displayName||null,location:location||null,bio:bio||null,font_style:fontStyle||'default'};const { error } = await supabase.from('profiles').update(payload).eq('id',session.user.id);if(error){console.error('Save profile',error);safeAlert('Could not save profile')}else safeAlert('Saved')}

        function handlePhotoSelect(e){if(!session||!e.target.files||!e.target.files[0])return;const file=e.target.files[0];if(file.size>MAX_PROFILE_PHOTO_BYTES){safeAlert('Photo must be under 10MB');return}if(pendingPhotoUrl){URL.revokeObjectURL(pendingPhotoUrl)}setPendingPhoto(file);setPendingPhotoUrl(URL.createObjectURL(file))}

        function cancelProfilePhoto(){if(pendingPhotoUrl){URL.revokeObjectURL(pendingPhotoUrl)}setPendingPhoto(null);setPendingPhotoUrl(null)}

        function resizeImageToSquare(file,size=256){
          return new Promise((resolve,reject)=>{
            const img=new Image();
            img.onload=()=>{
              try{
                const canvas=document.createElement('canvas');
                canvas.width=size;canvas.height=size;
                const ctx=canvas.getContext('2d');
                const iw=img.width, ih=img.height;
                const scale=Math.max(size/iw,size/ih);
                const sw=size/scale, sh=size/scale;
                const sx=(iw-sw)/2, sy=(ih-sh)/2;
                ctx.drawImage(img,sx,sy,sw,sh,0,0,size,size);
                if(canvas.toBlob){
                  canvas.toBlob(b=>b?resolve(b):reject(new Error('Blob failed')),'image/jpeg',0.9)
                }else{
                  try{
                    const dataUrl=canvas.toDataURL('image/jpeg',0.9);
                    const byteString=atob(dataUrl.split(',')[1]);
                    const mimeString=dataUrl.split(',')[0].split(':')[1].split(';')[0];
                    const ab=new ArrayBuffer(byteString.length);
                    const ia=new Uint8Array(ab);
                    for(let i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}
                    resolve(new Blob([ab],{type:mimeString}))
                  }catch(e){reject(e)}
                }
              }catch(err){reject(err)}
            };
            img.onerror=(e)=>{reject(e)};
            img.src=URL.createObjectURL(file)
          })
        }

        async function saveProfilePhoto(){
          if(!session||!pendingPhoto)return;
          try{
            setUploadingPhoto(true);
            const resized=await resizeImageToSquare(pendingPhoto,256);
            const resizedFile=new File([resized],'avatar.jpg',{type:'image/jpeg'});
            const url=await uploadToBucket(resizedFile,session.user.id,'photos');
            if(!url){
              safeAlert('Upload failed. See console for details.');
              return;
            }
            const { error } = await supabase.from('profiles').update({profile_photo_:url}).eq('id',session.user.id);
            if(error){
              console.error('Photo save error',error);
              safeAlert(`Failed to save photo: ${error.message||'check RLS policy on profiles'}`)
            }else{
              setProfile(prev=>prev?{...prev,profile_photo_:url}:prev);
              await new Promise(r=>setTimeout(r,200));
              const { data: fresh, error: selErr } = await supabase.from('profiles').select('*').eq('id',session.user.id).maybeSingle();
              if(selErr){ console.error('Profile reload error',selErr); }
              if(fresh){ setProfile(fresh); }
              safeAlert('Photo saved!')
            }
          }catch(err){
            console.error('Resize/upload error',err);
            safeAlert('Could not process photo')
          }finally{
            if(pendingPhotoUrl){URL.revokeObjectURL(pendingPhotoUrl)}
            setPendingPhoto(null);setPendingPhotoUrl(null);setUploadingPhoto(false)
          }
        }

        async function handleVideoUpload(e){if(!session||!e.target.files||!e.target.files[0])return;const file=e.target.files[0];if(file.size>MAX_INTRO_VIDEO_BYTES){safeAlert('Video must be under 25MB');return}const video=document.createElement('video');video.preload='metadata';video.onloadedmetadata=async()=>{window.URL.revokeObjectURL(video.src);if(video.duration>5.5){safeAlert('Video must be 5 seconds or less');return}setUploadingVideo(true);const url=await uploadToBucket(file,session.user.id,'intro-videos');if(url){const{error}=await supabase.from('profiles').update({avatar_url:url}).eq('id',session.user.id);if(!error){await loadProfile(session.user);safeAlert('Intro video uploaded!')}else{console.error('Video save error',error);safeAlert('Failed to save video')}}setUploadingVideo(false)};video.src=URL.createObjectURL(file)}

        function toggle(setter,arr,label){setter(prev=>prev.includes(label)?prev.filter(x=>x!==label):prev.concat(label))}

        async function loadFeed(){
          setLoadingFeed(true);
          if(!session){setLoadingFeed(false);return}
          const currentUserId = session.user.id;
          
          // Load all posts with author profile info
          let res = await supabase.from('posts').select('id,content,created_at,author_id,author_handle,circlez,mood,media_urls,profiles!posts_author_id_fkey(certified)').order('created_at',{ascending:false}).limit(50);
          if(res.error){console.error('Feed error:',res.error);setLoadingFeed(false);return}
          const allPosts = res.data||[];
          
          // Load viewer's relationships (which circles others assigned me to)
          const { data: myRelationships } = await supabase.from('relationships').select('owner_id,circle').eq('member_id',currentUserId);
          const circleMap = {};
          (myRelationships||[]).forEach(r => circleMap[r.owner_id] = r.circle);
          
          // Filter posts based on circle visibility
          const visiblePosts = allPosts.filter(p => {
            if(p.author_id === currentUserId) return true; // Always see your own posts
            const assignedCircle = circleMap[p.author_id];
            if(!assignedCircle) return true; // No relationship = public view (show all for now)
            const postCircles = p.circlez || [];
            return postCircles.includes(assignedCircle); // Only show if assigned circle matches post's circles
          });
          
          setFeed(visiblePosts.map(p=>({id:p.id,content:p.content||'',created_at:p.created_at,circlez:p.circlez||[],mood:p.mood||[],author_id:p.author_id,author_handle:p.author_handle||'',certified:p.profiles?.certified||false,media_urls:p.media_urls||[]})))
          setLoadingFeed(false)
        }

        async function loadStories(circle){
          if(!session)return;
          const { data, error } = await supabase
            .from('relationships')
            .select('member_id,circle,profiles!relationships_member_id_fkey(handle,display_name,profile_photo_)')
            .eq('owner_id',session.user.id)
            .eq('circle',circle);
          if(error){console.error('Stories load error',error);setStoriesMembers([]);return}
          setStoriesMembers((data||[]).map(r=>({
            id:r.member_id,
            handle:r.profiles?.handle||'@member',
            display_name:r.profiles?.display_name||null,
            photo:r.profiles?.profile_photo_||null
          })));
        }

        async function openStory(member){
          setStoryOpen(member);setStoryIndex(0);setStoryPosts([]);
          const { data, error } = await supabase
            .from('posts')
            .select('id,content,created_at')
            .eq('author_id',member.id)
            .order('created_at',{ascending:false})
            .limit(10);
          if(error){console.error('Load story posts',error);return}
          setStoryPosts(data||[]);
        }
        function closeStory(){setStoryOpen(null);setStoryPosts([]);setStoryIndex(0)}
        function nextStory(){setStoryIndex(i=>Math.min(i+1,Math.max(0,storyPosts.length-1)))}
        function prevStory(){setStoryIndex(i=>Math.max(i-1,0))}

        async function post(){
          if(!session||(!content.trim()&&composeMedia.length===0))return;
          setComposingMedia(true);
          const user=session.user;
          const mediaUrls=[];
          
          // Upload media files
          for(const mediaItem of composeMedia){
            try{
              const timestamp=Date.now();
              const random=Math.random().toString(36).slice(2);
              const ext=mediaItem.type==='video'?'.mp4':'.jpg';
              const filename=`${user.id}_${timestamp}_${random}${ext}`;
              const path=`posts/${filename}`;
              console.log('ðŸš€ Uploading media:',{path,size:mediaItem.file.size,type:mediaItem.type});
              const { data, error } = await supabase.storage.from('media').upload(path,mediaItem.file,{upsert:false});
              if(error){console.error('âŒ Media upload error:',error);safeAlert('Failed to upload media: '+error.message);continue}
              console.log('âœ… Media uploaded:',data);
              const urlObj=supabase.storage.from('media').getPublicUrl(path);
              const url=urlObj.data?.publicUrl;
              if(url){
                console.log('ðŸ”— Media URL:',url);
                mediaUrls.push(url);
              }else{
                console.error('âŒ Failed to get public URL');
              }
            }catch(err){console.error('âŒ Upload error:',err);safeAlert('Error uploading media')}
          }
          
          const payload={content:content.trim(),author_id:user.id,author_handle:(profile?.handle||getHandleForUser(user)),circlez:selectedCircles,mood:selectedMoods,media_urls:mediaUrls.length>0?mediaUrls:null};
          console.log('ðŸ“ Posting with payload:',payload);
          const { error } = await supabase.from('posts').insert(payload);
          if(error){console.error('âŒ Post error',error);safeAlert('Could not post: '+error.message);setComposingMedia(false);return}
          console.log('âœ… Post created successfully');
          setContent('');setSelectedMoods([]);setComposeMedia([]);setComposingMedia(false);await loadFeed();
          safeAlert('Posted!');
        }

        function handleComposeMediaSelect(e){
          if(!e.target.files)return;
          const newMedia=Array.from(e.target.files).map(file=>{
            const isVideo=file.type.startsWith('video/');
            const isImage=file.type.startsWith('image/');
            if(!isVideo&&!isImage){safeAlert('Please select an image or video');return null}
            const maxSize=isVideo?MAX_POST_VIDEO_BYTES:MAX_POST_IMAGE_BYTES;
            if(file.size>maxSize){
              const maxMB=Math.floor(maxSize/(1024*1024));
              const fileMB=(file.size/(1024*1024)).toFixed(1);
              safeAlert(`File too large: ${fileMB}MB (max ${maxMB}MB for ${isVideo?'videos':'images'})`);
              return null
            }
            return{file,url:URL.createObjectURL(file),type:isVideo?'video':'image'};
          }).filter(Boolean);
          setComposeMedia(prev=>[...prev,...newMedia]);
        }

        function removeComposeMedia(idx){
          setComposeMedia(prev=>prev.filter((_,i)=>i!==idx));
        }

        async function searchUser(){
          if(!searchEmail.trim())return;
          const { data, error } = await supabase.from('profiles').select('id,handle,display_name,certified').eq('id',(await supabase.auth.admin.getUserByEmail?.(searchEmail))?.data?.user?.id||'').maybeSingle();
          if(error||!data){
            const { data: byHandle } = await supabase.from('profiles').select('id,handle,display_name,certified').ilike('handle','%'+searchEmail+'%').limit(1).maybeSingle();
            setSearchResult(byHandle);
          } else setSearchResult(data);
        }

        async function assignCircle(memberId,circle){
          if(!session)return;
          const payload = {owner_id:session.user.id,member_id:memberId,circle:circle};
          const { error } = await supabase.from('relationships').upsert(payload,{onConflict:'owner_id,member_id'});
          if(error){console.error('Assign error',error);safeAlert('Could not assign circle')}
          else{safeAlert('Circle assigned!');loadMyFollowers()}
        }

        async function toggleCertified(userId,currentStatus){
          if(!session||!isAdmin(session.user)){safeAlert('Admin only');return}
          const newStatus = !currentStatus;
          const { error } = await supabase.from('profiles').update({certified:newStatus}).eq('id',userId);
          if(error){console.error('Certify error',error);safeAlert('Failed to update certified status')}
          else{safeAlert(newStatus?'User certified!':'Certification removed');await searchUser()}
        }

        async function loadLogo(){
          try{
            const url = supabase.storage.from('media').getPublicUrl('cz-logo.png').data.publicUrl+'?t='+Date.now();
            console.log('Logo URL:',url);
            setLogoUrl(url);
          }catch(err){console.error('Logo load error:',err)}
        }

        async function handleLogoUpload(e){
          if(!session||!isAdmin(session.user)){safeAlert('Admin only');return}
          if(!e.target.files||!e.target.files[0])return;
          const file = e.target.files[0];
          if(!file.type.startsWith('image/')){safeAlert('Please upload an image');return}
          try{
            setUploadingLogo(true);
            const path = 'cz-logo.png';
            const { error } = await supabase.storage.from('media').upload(path, file, {upsert:true});
            if(error){console.error('Logo upload error:',error);safeAlert('Failed to upload: '+error.message)}
            else{
              const url = supabase.storage.from('media').getPublicUrl(path).data.publicUrl+'?t='+Date.now();
              setLogoUrl(url);
              safeAlert('Logo updated!');
            }
          }catch(err){
            console.error('Logo error',err);
            safeAlert('Could not upload logo');
          }finally{
            setUploadingLogo(false);
          }
        }

        async function loadMyFollowers(){
          if(!session)return;
          const { data } = await supabase.from('relationships').select('member_id,circle,profiles!relationships_member_id_fkey(handle,display_name)').eq('owner_id',session.user.id);
          setMyFollowers(data||[]);
        }

        async function loadMediaGallery(){
          if(!session)return;
          const { data, error } = await supabase
            .from('posts')
            .select('id,content,created_at,media_urls')
            .eq('author_id',session.user.id)
            .order('created_at',{ascending:false})
            .limit(100);
          if(error){console.error('Load media gallery',error);return}
          const items = [];
          (data||[]).forEach(post=>{
            if(post.media_urls && Array.isArray(post.media_urls)){
              post.media_urls.forEach(url=>{
                if(url){
                  items.push({id:post.id,url:url,content:post.content,created_at:post.created_at,type:url.includes('.mp4')||url.includes('.webm')||url.includes('video')?'video':'image'});
                }
              });
            }
          });
          setMediaGallery(items);
        }

        async function logout(){
          try{await supabase.auth.signOut({ scope:'global' });}
          catch(e){console.error('Sign out error:',e)}
          try{
            setSession(null);setProfile(null);setFeed([]);
            const target = window.location.origin + '/';
            if(window.location.href !== target){
              window.location.replace(target);
            }else{
              window.location.reload();
            }
          }catch(err){
            console.error('Logout redirect error:',err);
            // Last-resort hard nav to root (fixes broken /legacy.html links on prod)
            window.location.href = '/';
          }
        }

        if(loading)return React.createElement('div',{className:'panel'},'Loading...');
        if(!session)return React.createElement(LoginScreen,null)

        const handle = profile?.handle || getHandleForUser(session.user);
        const circleOptions=['Family','Close Friends','Work','Community','Fans / Public'];
        const moodOptions=['Laugh','Learn','Music','Peace','Motivation'];
        const fontOptions=[{value:'default',label:'Default'},{value:'serif',label:'Serif'},{value:'mono',label:'Mono'},{value:'rounded',label:'Rounded'},{value:'display',label:'Display'}];

        return React.createElement('div',{className:'app font-'+fontStyle},
          React.createElement('div',{className:'brand'},
            React.createElement('img',{src:logoUrl,alt:'CIRCLEZ',className:'brand-logo',onError:e=>{e.target.style.display='none'}}),
            React.createElement('div',{className:'brand-title'},'CIRCLEZ')
          ),

          React.createElement('div',{className:'panel'},
            React.createElement('div',{className:'row',style:{marginBottom:8}},
              React.createElement('div',{style:{fontWeight:700}},'Stories'),
              React.createElement('div',{className:'chips'},['Family','Close Friends','Work','Community','Fans / Public'].map(label=>React.createElement('button',{key:label,className:'chip'+(storiesCircle===label?' selected':''),onClick:()=>setStoriesCircle(label)},label)))
            ),
            React.createElement('div',{className:'stories'},
              storiesMembers.length===0?React.createElement('div',{className:'meta'},'No people in this circle yet.'):
              storiesMembers.map(m=>React.createElement('div',{key:m.id,className:'story'},
                React.createElement('div',{className:'story-ring'},
                  m.photo?React.createElement('img',{src:m.photo,className:'story-ava',onClick:()=>openStory(m)}):
                  React.createElement('div',{className:'story-ava',onClick:()=>openStory(m)},(m.handle||'@u')[1]?.toUpperCase()||'U')
                ),
                React.createElement('div',{style:{fontSize:12,opacity:0.9,maxWidth:70,textAlign:'center'}},(m.display_name||m.handle).replace('@',''))
              ))
            )
          ),

          storyOpen?React.createElement('div',{className:'overlay',onClick:closeStory},
            React.createElement('div',{className:'overlay-card',onClick:e=>e.stopPropagation()},
              React.createElement('div',{className:'row',style:{marginBottom:8}},
                React.createElement('div',{style:{fontWeight:700}},storyOpen.display_name||storyOpen.handle),
                React.createElement('div',{style:{marginLeft:'auto'}},
                  React.createElement('button',{className:'btn',onClick:prevStory},'Prev'),
                  React.createElement('button',{className:'btn',onClick:nextStory,style:{marginLeft:6}},'Next'),
                  React.createElement('button',{className:'btn',onClick:closeStory,style:{marginLeft:6}},'Close')
                )
              ),
              storyPosts.length===0?React.createElement('div',{className:'meta'},'No posts yet.'):
              React.createElement('div',null,
                React.createElement('div',{className:'meta'},new Date(storyPosts[storyIndex]?.created_at||Date.now()).toLocaleString()),
                React.createElement('div',{style:{marginTop:10,fontSize:18,lineHeight:1.4}},storyPosts[storyIndex]?.content||'')
              )
            )
          ):null,
          React.createElement('div',{className:'panel'},
            React.createElement('div',{className:'row',style:{alignItems:'center',marginBottom:8}},
              (pendingPhotoUrl||profile?.profile_photo_)?
                React.createElement('img',{src:pendingPhotoUrl||profile.profile_photo_,style:{width:50,height:50,borderRadius:999,objectFit:'cover',border:'2px solid rgba(34,197,94,0.5)',marginRight:10}}):
                React.createElement('div',{style:{width:50,height:50,borderRadius:999,background:'rgba(34,197,94,0.15)',border:'2px solid rgba(34,197,94,0.5)',marginRight:10,display:'flex',alignItems:'center',justifyContent:'center',fontSize:20,fontWeight:700,color:'rgba(34,197,94,0.9)'}},handle?handle[1].toUpperCase():'?'),
              React.createElement('div',{style:{flex:1,minWidth:0}},React.createElement('div',{style:{fontWeight:700,display:'flex',alignItems:'center',gap:6}} , handle,profile?.certified?React.createElement(CertifiedBadge,{size:20}):null))
            ),
            React.createElement('div',{className:'row',style:{gap:6,marginBottom:8}},
              React.createElement('button',{className:'btn',onClick:()=>setEditingProfile(!editingProfile)},editingProfile?'Cancel':'Edit Profile'),
              React.createElement('button',{className:'btn'+(currentView==='media'?' primary':''),onClick:()=>{setCurrentView('media');loadMediaGallery()}},'Media'),
              React.createElement('button',{className:'btn',onClick:logout},'Log out')
            ),
            React.createElement('div',{style:{height:8}}),
            profile?.avatar_url?React.createElement('div',{style:{marginBottom:8}},React.createElement('video',{src:profile.avatar_url,controls:true,style:{width:'100%',maxWidth:300,borderRadius:8,border:'2px solid rgba(34,197,94,0.5)'}})):null,
            !editingProfile?React.createElement('div',null,
              React.createElement('div',{style:{marginTop:8}},displayName?React.createElement('div',{style:{marginBottom:4}},displayName):null),
              React.createElement('div',{style:{marginTop:4,opacity:0.8}},location||''),
              React.createElement('div',{style:{marginTop:8}},bio||'')
            ):React.createElement('div',null,
              React.createElement('input',{id:'photoInput',type:'file',accept:'image/*',capture:'user',onChange:handlePhotoSelect,style:{display:'none'}}),
              React.createElement('label',{htmlFor:'photoInput',className:'btn',style:{cursor:'pointer'}},pendingPhoto?'Choose Different Photo':'Choose Profile Photo'),
              pendingPhotoUrl?React.createElement('div',{className:'row',style:{marginTop:8,gap:10,alignItems:'center'}},
                React.createElement('img',{src:pendingPhotoUrl,style:{width:70,height:70,borderRadius:999,objectFit:'cover',border:'2px solid rgba(34,197,94,0.5)'}}),
                React.createElement('div',{className:'row',style:{gap:8}},
                  React.createElement('button',{className:'btn primary',onClick:saveProfilePhoto},uploadingPhoto?'Saving...':'Save Photo'),
                  React.createElement('button',{className:'btn',onClick:cancelProfilePhoto},'Cancel')
                )
              ):null,
              React.createElement('div',{style:{height:8}}),
              React.createElement('input',{id:'videoInput',type:'file',accept:'video/*',onChange:handleVideoUpload,style:{display:'none'}}),
              React.createElement('label',{htmlFor:'videoInput',className:'btn',style:{cursor:'pointer'}},uploadingVideo?'Uploading...':'Upload Intro Video (5s max)'),
              React.createElement('div',{style:{height:8}}),
              React.createElement('div',null,React.createElement('input',{className:'input',value:displayName,onChange:e=>setDisplayName(e.target.value),placeholder:'Display name'})),
              React.createElement('div',{style:{height:8}}),
              React.createElement('div',null,React.createElement('input',{className:'input',value:location,onChange:e=>setLocation(e.target.value),placeholder:'Location'})),
              React.createElement('div',{style:{height:8}}),
              React.createElement('div',null,React.createElement('textarea',{className:'textarea',value:bio,onChange:e=>setBio(e.target.value),placeholder:'Bio'})),
              React.createElement('div',{style:{height:8}}),
              React.createElement('div',null,React.createElement('div',{style:{marginBottom:6,fontWeight:700}},'Font Style'),React.createElement('div',{className:'chips'},fontOptions.map(f=>React.createElement('button',{key:f.value,className:'chip'+(fontStyle===f.value?' selected':''),onClick:()=>setFontStyle(f.value)},f.label)))),
              React.createElement('div',{style:{height:8}}),
              React.createElement('div',null,React.createElement('button',{className:'btn primary',onClick:saveProfile},'Save profile'))
            )
          ),

          React.createElement('div',{className:'panel'},
            React.createElement('div',{style:{fontWeight:700,marginBottom:10}},isAdmin(session?.user)?'Circle Me & Admin':'Circle Me'),
            
            isAdmin(session?.user)?React.createElement('div',{style:{marginBottom:12,paddingBottom:12,borderBottom:'1px solid rgba(148,163,184,0.08)'}},
              React.createElement('div',{style:{fontWeight:700,marginBottom:8,fontSize:14,color:'#22c55e'}},'âš™ ADMIN CONTROLS'),
              React.createElement('div',{style:{fontWeight:600,marginBottom:6,fontSize:12}},'Change Logo'),
              React.createElement('input',{id:'logoInput',type:'file',accept:'image/*',onChange:handleLogoUpload,style:{display:'none'}}),
              React.createElement('label',{htmlFor:'logoInput',className:'btn',style:{cursor:'pointer',display:'block',textAlign:'center'}},uploadingLogo?'Uploading...':'ðŸ“¤ Upload New Logo')
            ):null,

            React.createElement('div',{className:'row'},
              React.createElement('input',{className:'input',style:{flex:1},value:searchEmail,onChange:e=>setSearchEmail(e.target.value),placeholder:'Search by email or handle'}),
              React.createElement('button',{className:'btn',onClick:searchUser},'Search')
            ),
            searchResult?React.createElement('div',{style:{marginTop:10}},
              React.createElement('div',{style:{marginBottom:8}},searchResult.display_name||searchResult.handle),
              React.createElement('div',{className:'chips'},circleOptions.map(c=>React.createElement('button',{key:c,className:'chip',onClick:()=>assignCircle(searchResult.id,c)},c))),
              isAdmin(session?.user)?React.createElement('div',{style:{marginTop:10}},
                React.createElement('button',{className:'btn primary',onClick:()=>toggleCertified(searchResult.id,searchResult.certified)},searchResult.certified?'Remove Certified':'Grant Certified')
              ):null
            ):null,
            React.createElement('div',{style:{marginTop:10}},
              React.createElement('button',{className:'btn',onClick:loadMyFollowers},'Show My Circlez'),
              myFollowers.length>0?React.createElement('div',{style:{marginTop:8}},myFollowers.map(f=>React.createElement('div',{key:f.member_id,style:{padding:8,borderRadius:8,background:'rgba(255,255,255,0.02)',marginBottom:6}},
                React.createElement('div',null,(f.profiles?.display_name||f.profiles?.handle||'User')+' â†’ '+f.circle)
              ))):null
            )
          ),

          React.createElement('div',{className:'panel'},
            React.createElement('div',{className:'panel-title-row row'},React.createElement('div',{style:{fontWeight:700}},'Compose'),React.createElement('div',null,React.createElement('span',{className:'chip'},'Live to your circlez'))),
            React.createElement('div',{style:{height:6}}),
            React.createElement('textarea',{className:'textarea',value:content,onChange:e=>setContent(e.target.value),placeholder:'Drop a thoughtâ€¦'}),
            React.createElement('div',{style:{height:8}}),
            composeMedia.length>0?
            React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(80px,1fr))',gap:6,marginBottom:10,padding:8,background:'rgba(34,197,94,0.05)',borderRadius:8,border:'1px solid rgba(34,197,94,0.2)'}},
              composeMedia.map((m,i)=>React.createElement('div',{key:i,style:{aspectRatio:'1/1',position:'relative',borderRadius:6,overflow:'hidden',border:'1px solid rgba(34,197,94,0.3)',background:'rgba(0,0,0,0.3)'}},
                m.type==='video'?
                React.createElement('video',{src:m.url,style:{width:'100%',height:'100%',objectFit:'cover'}}):
                React.createElement('img',{src:m.url,style:{width:'100%',height:'100%',objectFit:'cover'}}),
                React.createElement('button',{onClick:()=>removeComposeMedia(i),style:{position:'absolute',top:2,right:2,background:'rgba(239,68,68,0.9)',color:'white',border:'none',borderRadius:999,width:24,height:24,cursor:'pointer',fontSize:14,display:'flex',alignItems:'center',justifyContent:'center',padding:0}},'+')
              ))
            ):
            React.createElement('div',{style:{padding:12,textAlign:'center',background:'rgba(34,197,94,0.05)',borderRadius:8,border:'1.5px dashed rgba(34,197,94,0.3)',marginBottom:10,color:'rgba(34,197,94,0.7)',fontSize:13}},composeMedia.length===0?'ðŸ“¸ Add photos or videos to your post':''),
            React.createElement('div',{className:'row',style:{gap:6,marginBottom:8}},
              React.createElement('input',{id:'composeMediaInput',type:'file',accept:'image/*,video/*',multiple:true,onChange:handleComposeMediaSelect,style:{display:'none'}}),
              React.createElement('label',{htmlFor:'composeMediaInput',className:'btn',style:{cursor:'pointer',flex:1,textAlign:'center'}},'ðŸ“· Add Media'),
              composeMedia.length>0?React.createElement('button',{className:'btn',onClick:()=>setComposeMedia([])},'Clear'):null
            ),
            React.createElement('div',null,React.createElement('div',{className:'panel-title',style:{marginBottom:6}},'Circlez'),React.createElement('div',{className:'chips'},circleOptions.map(label=>React.createElement('button',{key:label,className:'chip'+(selectedCircles.includes(label)?' selected':''),onClick:()=>toggle(setSelectedCircles,selectedCircles,label)},label)))),
            React.createElement('div',{style:{height:8}}),
            React.createElement('div',null,React.createElement('div',{className:'panel-title',style:{marginBottom:6}},'Mood / intent'),React.createElement('div',{className:'chips'},moodOptions.map(label=>React.createElement('button',{key:label,className:'chip'+(selectedMoods.includes(label)?' selected':''),onClick:()=>toggle(setSelectedMoods,selectedMoods,label)},label)))) ,
            React.createElement('div',{style:{height:10}}),
            React.createElement('div',null,React.createElement('button',{className:'btn primary'+(content.length>0||composeMedia.length>0?' glow':''),onClick:post,disabled:composingMedia},composingMedia?'Posting...':'Post to Circlez'))
          ),

          React.createElement('div',{className:'panel'},React.createElement('div',{className:'row'},React.createElement('div',{style:{fontWeight:700}},currentView==='media'?'Your Media':'Your feed'),React.createElement('div',{style:{marginLeft:'auto'}},React.createElement('button',{className:'btn',onClick:()=>setCurrentView('feed')},'Feed'),React.createElement('button',{className:'btn'+(currentView==='media'?' primary':''),onClick:()=>{setCurrentView('media');loadMediaGallery()},style:{marginLeft:4}},'Media'))),
            React.createElement('div',{style:{height:8}}),
            currentView==='feed'?
            feed.length===0?React.createElement('div',{className:'meta'},'No posts yet.'):
            React.createElement('div',null,feed.map(p=>React.createElement('div',{key:p.id,className:'post'},React.createElement('div',{style:{fontWeight:700,display:'flex',alignItems:'center',gap:6}},p.author_handle||'@member',p.certified?React.createElement(CertifiedBadge,{size:16}):null),React.createElement('div',{className:'meta'},formatDate(p.created_at)),React.createElement('div',{style:{marginTop:8}},p.content),p.media_urls&&p.media_urls.length>0?React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(100px,1fr))',gap:6,marginTop:8}},p.media_urls.map((url,idx)=>React.createElement('div',{key:idx,style:{aspectRatio:'1/1',borderRadius:8,overflow:'hidden',border:'1px solid rgba(34,197,94,0.3)',background:'rgba(0,0,0,0.3)'}},url.includes('.mp4')||url.includes('video')?React.createElement('video',{src:url,style:{width:'100%',height:'100%',objectFit:'cover'},controls:false}):React.createElement('img',{src:url,style:{width:'100%',height:'100%',objectFit:'cover'}})))):null,React.createElement('div',{className:'tags'},(p.circlez||[]).map(c=>React.createElement('span',{className:'chip',key:c},c)),(p.mood||[]).map(m=>React.createElement('span',{className:'chip',key:m},m))))))
            :
            mediaGallery.length===0?React.createElement('div',{className:'meta'},'No photos or videos yet.'):
            React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(120px,1fr))',gap:8}},
              mediaGallery.map(item=>React.createElement('div',{key:item.id,style:{aspectRatio:'1/1',borderRadius:8,overflow:'hidden',cursor:'pointer',border:'1px solid rgba(34,197,94,0.3)',background:'rgba(0,0,0,0.3)',position:'relative'}},
                item.type==='video'?
                React.createElement('video',{src:item.url,style:{width:'100%',height:'100%',objectFit:'cover',display:'block'},controls:false}):
                React.createElement('img',{src:item.url,style:{width:'100%',height:'100%',objectFit:'cover',display:'block'}}),
                React.createElement('div',{style:{position:'absolute',bottom:4,right:4,background:'rgba(34,197,94,0.8)',color:'white',padding:'2px 6px',borderRadius:4,fontSize:11,fontWeight:600}},item.type==='video'?'â–¶ VIDEO':'ðŸ“· PHOTO')
              ))
            )
          )
        )
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
